
    <script>
            $(document).ready(function (){
                var saving = false
                var lineCount = 1
                const roomNum = $('#roomId').val()
                const userName = $("#user_name").val()
                const instructor = $("#instructor").val()
                App.room = App.cable.subscriptions.create({
                    channel: "RoomsChannel",
                    room: roomNum
                },   {
                    connected: function() {
                        return this.perform('new_user', {name: userName})
                    },
                    disconnected: function() {
                        console.log('discon', userName);
                        return this.perform('user_left', {name: userName})
                    }, 
                    received(data) {
                        if(data.action == "send_code"){
                            $('#editor').val(data.code)
                        } else if (data.action == "new_user") {
                            if(userName == instructor ){
                                let radioButtons = ""
                                for(var i = 0; i < data.all_users.length; i++){
                                    radioButtons += '<p class="blocked person" id="'+ data.all_users[i] +'"><input type="radio" class="person blocked" name="typer" id="'+data.all_users[i] +'" value="'+data.all_users[i]+'"><label for="'+data.all_users[i] +'">'+data.all_users[i]+'</label></p>'
                                }
                            // let radioButton = $('<input type="radio" class="person" name="typer" id="'+data.name +'" value="'+data.name +'"><label for="'+data.name +'">'+data.name+'</label>')
                            // radioButton.appendTo('#users')
                                $('.users').html(radioButtons)
                        } else {
                            let radioButtons = ""
                            for(var i = 0; i < data.all_users.length; i++){
                                radioButtons += '<p class="blocked person" id="'+ data.all_users[i] +'"><input disabled type="radio" class="person blocked" name="typer" id="'+data.all_users[i] +'" value="'+data.all_users[i]+'"><label for="'+data.all_users[i] +'">'+data.all_users[i]+'</label></p>'
                            }
                            console.log(radioButtons);
                            // let radioButton = $('<input disabled type="radio" class="person" name="typer" id="'+data.name +'" value="'+data.name +'"><label for="'+data.name +'">'+data.name+'</label>')
                            // radioButton.appendTo('#users')
                            $('.users').html(radioButtons)
                        }
                        } else if (data.action == "change_user"){
                            if(userName == data.user){
                                console.log('permission granted');
                                $("#" + data.user + ".blocked").toggleClass("active")
                                $("#editor").removeAttr("disabled")
                            } else {
                                console.log('Not allowed to type');
                                $("#editor").prop('disabled', true);
                            }
                        } else if (data.action == 'user_left'){
                            console.log('leaver');
                        } else if (data.action == "chat_message"){
                            let msg = "<p class='chatMessage'>" + data.user + ": " + data.msg + "</p>"
                            $(".chatBox").prepend(msg)
                        }
                    },
            
                    send_code: function(text) {
                        if(!saving){
                            saving = true
                            chatObj = this;
                            setTimeout(this.update_code, 5000)
                        }
                        return this.perform('send_code', {code: text})
                    },
            
                    update_code: function() {
                        console.log('updating');
                        let text = $('textarea#editor').val();
                        console.log(text);
                        saving = false
                        return chatObj.perform('update_code', {
                            code: text,
                            room_id: roomNum
                        })
                    },
                    change_user: function(data){
                        return this.perform('change_user', {
                            user: data
                        })
                    },
                    send_message: function(text){
                        return this.perform("chat_message", {
                            msg: text,
                            user: userName
                        })
                    }
                });
                $("#editor").keyup(function(e){
                    let text = $('textarea#editor').val();
                    App.room.send_code(text)
                    // var lines = text.split(/\r|\r\n|\n/);
                    // var count = lines.length;
                    // console.log(count);
                    // console.log(lineCount);
                    // if(count != lineCount){
                    //     if(count > lineCount){
                    //         for(let i = lineCount; count > i; i++){
                    //             $('<p class="monospaced">' + i +'</p>').appendTo("#lineCount")
                    //     }
                    //         lineCount = count
                    //     } else {
                    //         for(let x = lineCount; count < x; x--){
                    //             $("#lineCount p").last().remove()
                    //         }
                    //         lineCount = count
                    //     }
                    // }
                });
                $('.users').on("click", 'input:radio', (function(){
                    App.room.change_user($(this).attr('value'))
                }));
                $("#chatMessage").keypress(function(e){
                    if(e.which == 13){
                        e.preventDefault();
                        let msg = $("#chatMessage").val();
                        if(msg.length > 0){
                            App.room.send_message(msg)
                            $("#chatMessage").val('')
                        }
                    }
                });
              });
    </script>
<div class="row">
    <div class="col-6">
        <h1><%= @room.title %></h1>
        <p>Created by <%= @room.user.name %></p>
    </div>
    <div class="col-2">
        <h4 class="mt-5">Users</h4>
    </div>
    <div class="col-4">
        <h3 class="mt-5">Chat</h3>
    </div>
</div>
<div class="row">
    <div class='col-6'>
        <div id="users">
        </div>
        <div id="lineCount">
        </div>
        <textarea name="editor" id="editor" cols="30" rows="10"><%= @room.code %></textarea>
        <input type="hidden" name="roomId" id="roomId" value="<%= @room.id %>">
        <input type="hidden" name="user_name" id="user_name" value="<%= current_user.name %>">
        <input type="hidden" name="instructor" id="instructor" value="<%= @room.user.name %>">
    </div>
    <div class="col-2 users">
    </div>
    <div class="col-4">
        <div class="chatBox">
        </div>
        <form action="">
            <div class="form-group">
              <input type="text" class="form-control" name="chatMessage" id="chatMessage" aria-describedby="helpId" placeholder="">
            </div>
        </form>
    </div>
</div>
